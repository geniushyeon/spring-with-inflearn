# íšŒì› ì„œë¹„ìŠ¤ ê°œë°œ

## 1. MemberService
ë¹„ì¦ˆë‹ˆìŠ¤ì— ì˜ì¡´ì ìœ¼ë¡œ ì„¤ê³„
- RepositoryëŠ” ê¸°ê³„ì ìœ¼ë¡œ ê°œë°œìŠ¤ëŸ½ê²Œ(?) ìš©ì–´ë“¤ì„ ì„ íƒí•œë‹¤.
### 1.1. íšŒì›ê°€ì…
- ì´ë¦„ì´ ì¤‘ë³µëœ íšŒì›ì€ ê°€ì…ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤ê³  ê°€ì •í•˜ê³  ì‘ì„±
```java
package hello.hellospring.service;

import hello.hellospring.domain.Member;
import hello.hellospring.repository.MemberRepository;
import hello.hellospring.repository.MemoryMemberRepository;

import java.util.Optional;

public class MemberService {

    private final MemberRepository memberRepository = new MemoryMemberRepository();

    /*
     * íšŒì›ê°€ì…
     * */
    public Long join(Member member) {
        // ì´ë¦„ ì¤‘ë³µ íšŒì› X
        Optional<Member> result = memberRepository.findByName(member.getName());
        result.ifPresent(m -> {
            throw new IllegalStateException("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");
        });


        memberRepository.save(member);

        return member.getId();
    }

}
```
- ğŸ’¡ ë³€ìˆ˜ ì¶”ì¶œí•˜ê¸° (Extract -> Variable): `cmd + opt + v` 

#### ğŸ“ Option<T>ì— ê´€í•˜ì—¬
- ìœ„ ì½”ë“œì˜ ê²½ìš° Memberê°€ Optionalë¡œ í•œ ë²ˆ ë” ê°ì‹¸ì§€ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì—, Optionalì˜ ì—¬ëŸ¬ ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
- .ifPresent(): ì–´ë–¤ ê°’ì´ ìˆìœ¼ë©´ ì–´ë–¤ ë¡œì§ì„ ì‹¤í–‰í•´ì¤˜
  - if (result != null)ê³¼ ê°™ë‹¤.
- .orElseGet(): ê°’ì´ ìˆìœ¼ë©´ êº¼ë‚´ê³  ì—†ìœ¼ë©´ ì–´ë–¤ ë¡œì§ì„ ì‹¤í–‰í•´ì¤˜

- result ë³€ìˆ˜ë¥¼ ë§Œë“¤ì§€ ì•Šê³  ë°”ë¡œ ì“¸ ìˆ˜ë„ ìˆë‹¤.
```java
public Long join(Member member) {
    // ì´ë¦„ ì¤‘ë³µ íšŒì› X
    memberRepository.findByName(member.getName())
            .ifPresent(m -> {
                throw new IllegalStateException("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤."); 
            });
        
    memberRepository.save(member);

    return member.getId();
}
```
- findByName(ë¸”ë¼ë¸”ë¼~ ...) ì´ë ‡ê²Œ ë¡œì§ì´ ìˆì„ ë•ŒëŠ” ë©”ì†Œë“œë¡œ ë½‘ëŠ” ê²ƒì´ ì¢‹ë‹¤.
  - ğŸ’¡ ë¦¬íŒ©í† ë§ ê´€ë ¨ ë‹¨ì¶•í‚¤ `ctrl + T`(ì»¤ë§¨ë“œì•„ë‹˜) -> Extract Methodí•´ì„œ ë”°ë¡œ ë½‘ì•„ì£¼ê¸°.

```java
/*
 * íšŒì›ê°€ì…
 * */
public Long join(Member member) {
    // ì´ë¦„ ì¤‘ë³µ íšŒì› X
    validateDuplicatedMember(member);

    memberRepository.save(member);

    return member.getId();
}

private void validateDuplicatedMember(Member member) {
    memberRepository.findByName(member.getName())
            .ifPresent(m -> {
                throw new IllegalStateException("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");
            });
}
```

### 1.2. ì „ì²´ ì½”ë“œ
```java
package hello.hellospring.service;

import hello.hellospring.domain.Member;
import hello.hellospring.repository.MemberRepository;
import hello.hellospring.repository.MemoryMemberRepository;

import java.util.List;
import java.util.Optional;

public class MemberService {

    private final MemberRepository memberRepository = new MemoryMemberRepository();

    /*
     * íšŒì›ê°€ì…
     * */
    public Long join(Member member) {
        validateDuplicatedMember(member); // ì¤‘ë³µ íšŒì› ê²€ì¦
        memberRepository.save(member);

        return member.getId();
    }

    private void validateDuplicatedMember(Member member) {
        memberRepository.findByName(member.getName())
                .ifPresent(m -> {
                    throw new IllegalStateException("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");
                });
    }

    /*
    * ì „ì²´ íšŒì› ì¡°íšŒ
   * */
    public List<Member> findMembers() {
        return memberRepository.findAll();
    }

    public Optional<Member> findOne(Long memberId) {
        return memberRepository.findById(memberId);
    }

}
```

## 2. MemberService í…ŒìŠ¤íŠ¸
ì´ì „ì—ëŠ” test í´ë” ì•„ë˜ì— í´ë˜ìŠ¤ë¥¼ ìƒˆë¡œ ë§Œë“¤ì—ˆì—ˆëŠ”ë°, ğŸ’¡ `cmd + shift + T`ë¥¼ ëˆ„ë¥´ë©´ ë°”ë¡œ Testë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.<br/>
![screenshot](img/day5_testshortcut.png)<br/>
- í´ë¦­í•˜ë©´<br/>
![screenshot](img/day5_createtest.png)<br/>
- ì´ëŸ° ì°½ì´ ëœ¬ë‹¤.
  - Test libraryëŠ” `JUnit5`ë¥¼ ì„ íƒí•˜ê³ , í…ŒìŠ¤íŠ¸í•  ë©”ì†Œë“œë¥¼ ì²´í¬í•œ í›„ OKë¥¼ ëˆ„ë¥´ë©´ ë¨.
  - ê·¸ëŸ¬ë©´ í‹€ì„ ë§Œë“¤ì–´ì£¼ëŠ”ë°, ì§ì ‘ ë§Œë“¤ ë•Œì™€ ë™ì¼í•˜ê²Œ `test/java` ì•„ë˜ì— ë§Œë“¤ì–´ì§„ë‹¤.
![screenshot](img/day5_testcreated.png)

### 2.1. given ~ when ~ then
```text
// given
ë­”ê°€ê°€ ì£¼ì–´ì¡ŒëŠ”ë°
(ì´ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ”êµ¬ë‚˜)
// when
ê·¸ëŸ° ìƒí™©ì¼ ë•Œ
(ì´ê±¸ ê²€ì¦í•˜ëŠ”êµ¬ë‚˜)
// then
ì´ê²Œ ë‚˜ì™€ì•¼ í•´
(ì—¬ê¸°ê°€ ê²€ì¦í•˜ëŠ” ë¶€ë¶„ì´êµ¬ë‚˜)
```

### 2.2. íšŒì›ê°€ì… í…ŒìŠ¤íŠ¸
```java
MemberService memberService = new MemberService();

@Test
void join() {
    // given
    Member member = new Member();
    member.setName("hello");
    // when
    Long savedId = memberService.join(member);

    // then
    // ì €ì¥í•œê²Œ repositoryì— ìˆëŠ”ê²Œ ë§ì•„?
    Member findMember = memberService.findOne(savedId).get();
    assertThat(member.getName()).isEqualTo(findMember.getName());

}
```
- ğŸ’¡ static import: static importí•˜ê³ ì‹¶ì€ ê³³ì— ì»¤ì„œ ê°€ì ¸ê°„ ë’¤ `opt + Enter` -> add static import for~
![screenshot](img/day5_staticimport.png)<br/>

#### 2.2.1. ì˜ˆì™¸ í…ŒìŠ¤íŠ¸(1)
ëª¨ë“  í…ŒìŠ¤íŠ¸ëŠ” ì •ìƒ í…ŒìŠ¤íŠ¸ë³´ë‹¤ `ì˜ˆì™¸ í…ŒìŠ¤íŠ¸`ê°€ í›¨ì”¬ ì¤‘ìš”í•˜ë‹¤.
- ì´ë¦„ì´ ì¤‘ë³µë˜ëŠ” íšŒì›ì€ ê°€ì…ì´ ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ ì¤‘ë³µí™•ì¸ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ë§Œë“ ë‹¤.
```java
@Test
public void validateDuplicatedCheck() {
    // given
    Member member1 = new Member();
    member1.setName("spring");

    Member member2 = new Member();
    member2.setName("spring");

    // when
    memberService.join(member1);
    try {
        memberService.join(member2);
        fail();
    } catch (IllegalStateException e) {
        assertThat(e.getMessage()).isEqualTo("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");
    }

    // then
}
```
![screenshot](img/day5_duplicatedcheck1.png)
- MemberService í´ë˜ìŠ¤ì—ì„œ ê°™ì€ ì´ë¦„ì´ ì¡´ì¬í•˜ë©´ "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤."ë¼ëŠ” ë©”ì‹œì§€ë¥¼ ë¿Œë ¤ì£¼ë„ë¡ í–ˆëŠ”ë°, ì˜ˆì™¸ë¥¼ catchí–ˆì„ ë•Œ ê·¸ ì˜ˆì™¸ì˜ ë©”ì‹œì§€ê°€ "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤."ì™€ ê°™ìœ¼ë¯€ë¡œ í…ŒìŠ¤íŠ¸ ì„±ê³µ.
- ë§Œì•½ ë©”ì‹œì§€ë¥¼ ë°”ê¿”ë³´ë©´<br/>
![screenshot](img/day5_duplicatedcheck2.png)<br/>

#### 2.2.2. ì˜ˆì™¸ í…ŒìŠ¤íŠ¸(2)
assertThrowsë¥¼ ì´ìš©í•´ì„œ ì‘ì„±í•´ë³´ì.
```java
 @Test
public void validateDuplicatedCheck() {
    // given
    Member member1 = new Member();
    member1.setName("spring");

    Member member2 = new Member();
    member2.setName("spring");

    // when
    memberService.join(member1);
    assertThrows(IllegalStateException.class, () -> memberService.join(member2));
}
```
- assertThrows(ì´ ì˜ˆì™¸ê°€ í„°ì ¸ì•¼ í•¨, () -> ì–´ë–¤ ë¡œì§ì„ íƒœìš¸ ë•Œ);
  - ëŒë‹¤ ì–¸ì œ ê³µë¶€í•˜ì§€..<br/>
![screenshot](./img/day5_duplicatedcheck3.png)
- IllegalStateException ë§ê³  ë‹¤ë¥¸ ì—ëŸ¬ë¥¼ ë„£ìœ¼ë©´ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨í•¨.

#### 2.2.3. ì˜ˆì™¸ í…ŒìŠ¤íŠ¸(3)
ì˜ˆì™¸ ë©”ì‹œì§€ ê²€ì¦í•˜ê¸°
```java
IllegalStateException e = assertThrows(IllegalStateException.class, () -> memberService.join(member2));
assertThat(e.getMessage()).isEqualTo("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");
```

ğŸ’¡ 2.2.2. ì½”ë“œì—ì„œ `cmd + opt + v`

#### 2.2.4. ë°ì´í„° clearí•´ì£¼ëŠ” ë©”ì†Œë“œ ë§Œë“¤ê¸°
ì–´ì œ ë§Œë“¤ì—ˆë˜ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì—ì„œ ê°€ì ¸ì˜¨ë‹¤.

```java
MemoryMemberRepository memoryMemberRepository = new MemoryMemberRepository();

@AfterEach
public void afterEach() {
    memoryMemberRepository.clearStore();
}
```
- ì´ë ‡ê²Œ ë˜ë©´ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì— ìˆëŠ” memoryMemberRepositoryì™€ MemberServiceì— ìˆëŠ” repositoryê°€ ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ì—¬ì„œ ì• ë§¤í•´ì§„ë‹¤.
    - 1. MemberServiceì—ì„œ memoryMemberRepositoryë¥¼ ìƒì„±í•´ì£¼ëŠ” ìƒì„±ìë¥¼ ë§Œë“¤ê³ 
    - 2. MemberServiceTestì—ì„œ ê° í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰ë˜ê¸° ì´ì „ì— memoryMemberRepositoryë¥¼ ìƒì„±í•  ìˆ˜ ìˆë„ë¡ `@BeforeEach` ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì¸ ë©”ì†Œë“œë¥¼ ìƒì„±í•´ì¤€ë‹¤.
    - ì´ê²ƒì´ ë°”ë¡œ DI(Dependency Injection, ì˜ì¡´ì„± ì£¼ì…)

MemberService.java
```java
private final MemberRepository memberRepository;

public MemberService(MemberRepository memberRepository) {
    this.memberRepository = memberRepository;
}
```
MemberServiceTest.java
```java
MemberService memberService;
MemoryMemberRepository memoryMemberRepository;

@BeforeEach
public void beforeEach() {
    memoryMemberRepository = new MemoryMemberRepository();
    memberService = new MemberService(memoryMemberRepository);
}
```
# ìŠ¤í”„ë§ í†µí•© í…ŒìŠ¤íŠ¸
ì´ì „ì— í–ˆë˜ í…ŒìŠ¤íŠ¸ë“¤ì€ ìŠ¤í”„ë§ê³¼ ê´€ë ¨ ì—†ëŠ” í…ŒìŠ¤íŠ¸ì„(ìˆœìˆ˜ Java ì½”ë“œ).
- ìŠ¤í”„ë§ì´ë‘ ì—®ì–´ì„œ ì–´ë–»ê²Œ í…ŒìŠ¤íŠ¸í•˜ëŠ”ì§€ ë°°ìš¸ ê²ƒ
  - DBê¹Œì§€ ì—°ê²°í•´ì„œ í…ŒìŠ¤íŠ¸
- MemberServiceIntegrationTest.java
```java
package hello.hellospring.service;

import hello.hellospring.domain.Member;
import hello.hellospring.repository.MemberRepository;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.transaction.annotation.Transactional;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.Assertions.assertThrows;

@SpringBootTest
@Transactional
class MemberServiceIntegrationTest {

    // í•„ë“œ ë ˆë²¨ì—ì„œ Autowiredë¡œ ì˜ì¡´ì„± ì£¼ì…
    @Autowired
    MemberService memberService;
    @Autowired
    MemberRepository memoryMemberRepository;

    @Test
    void join() {
        // given
        Member member = new Member();
        member.setName("spring");
        // when
        Long savedId = memberService.join(member);

        // then
        // ì €ì¥í•œê²Œ repositoryì— ìˆëŠ”ê²Œ ë§ì•„?
        Member findMember = memberService.findOne(savedId).get();
        assertThat(member.getName()).isEqualTo(findMember.getName());

    }

    @Test
    public void validateDuplicatedCheck() {
        // given
        Member member1 = new Member();
        member1.setName("spring");

        Member member2 = new Member();
        member2.setName("spring");

        // when
        memberService.join(member1);
        IllegalStateException e = assertThrows(IllegalStateException.class, () -> memberService.join(member2));
        assertThat(e.getMessage()).isEqualTo("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");

    }
}
```
ì´ë ‡ê²Œ í•˜ê³  íšŒì›ê°€ì… í…ŒìŠ¤íŠ¸ë¥¼ ëŒë ¤ë³´ë©´<br/>
![](img/day10_test1.png)<br/>
- DBì™€ ì—°ê²°ì„ í•´ë’€ê³ , ì§€ë‚œ ì‹œê°„ì— springì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ íšŒì›ê°€ì…ì„ í–ˆê¸° ë•Œë¬¸ì— ì˜¤ë¥˜ ë°œìƒ
  - DBì— ìˆëŠ” ë°ì´í„° ì§€ì›Œì£¼ê³  ì‹œì‘í•˜ê¸°
```sql
DELETE from MEMBER;
```
- ë³´í†µ ì‹¤ë¬´ì—ì„œëŠ” í…ŒìŠ¤íŠ¸ìš© DBë¥¼ ë”°ë¡œ êµ¬ì¶•í•œë‹¤.<br/>

ì§€ìš°ê³  ë‚˜ì„œ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•´ë³´ë©´<br/>
![](img/day10_test2.png)<br/>
- í…ŒìŠ¤íŠ¸ì„ì—ë„ ìŠ¤í”„ë§ì´ ëŒì•„ê°€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
- `@SpringBootTest` ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ìœ¼ë©´ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì™€ í…ŒìŠ¤íŠ¸ë¥¼ í•¨ê»˜ ì‹¤í–‰í•œë‹¤.

## `@Transactional`ì— ëŒ€í•˜ì—¬
í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì— ì´ ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ìœ¼ë©´ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•  ë•Œ 
1) í…ŒìŠ¤íŠ¸ ì‹œì‘ ì „ì— íŠ¸ëœì­ì…˜ì„ ë¨¼ì € ì‹¤í–‰í•˜ê³  
2) ì¿¼ë¦¬ë¬¸ì„ ë‚ ë ¤ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•œ í›„
3) í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ë©´ `rollback`ì„ ì‹œì¼œì¤€ë‹¤.
- DBì— ì¿¼ë¦¬ë¬¸ì´ ë°˜ì˜ë˜ì§€ ì•ŠìŒ
  - ì „ í…ŒìŠ¤íŠ¸ì—ì„œ í–ˆë˜ @BeforeEach, @AfterEach ë“±ë“± ì“¸ í•„ìš” ì—†ìŒ

## ê·¸ëŸ¬ë©´ ìˆœìˆ˜ Javaë¡œ ëœ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ê°€ í•„ìš”ì—†ëŠëƒ?
- ìˆœìˆ˜ Java ì½”ë“œë¥¼ ì´ìš©í•´ ë‹¨ìœ„ë³„ë¡œ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒì„ `ë‹¨ìœ„ í…ŒìŠ¤íŠ¸`, ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì™€ ì—°ë™í•˜ì—¬ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒì„ `í†µí•© í…ŒìŠ¤íŠ¸`ë¼ê³  í‘œí˜„í•œë‹¤.
- `ë‹¨ìœ„ í…ŒìŠ¤íŠ¸`ê°€ ì¢‹ì€ í…ŒìŠ¤íŠ¸ì¼ í™•ë¥ ì´ ë†’ë‹¤.

# ìŠ¤í”„ë§ JdbcTemplate
- ìˆœìˆ˜ JDBCì™€ ë™ì¼í•˜ê²Œ í™˜ê²½ ì„¤ì •ì„ í•˜ë©´ ëœë‹¤.
- JDBC APIì—ì„œ ë³¸ ë°˜ë³µ ì½”ë“œë¥¼ ëŒ€ë¶€ë¶„ ì œê±°í•´ì¤€ë‹¤.
  - SQLì€ ì§ì ‘ ì‘ì„±í•´ì•¼ í•œë‹¤.

## JdbcTemplate
springì´ ì œê³µí•´ì£¼ëŠ” í…œí”Œë¦¿. ì‚¬ìš© ë°©ë²•ì€<br/>
1. í•„ë“œì˜ ë©¤ë²„ë¡œ ìƒì„±í•´ì£¼ê³ 
2. ìƒì„±ìì—ì„œ ìƒì„±í•´ì¤Œ(DataSourceë¥¼ ê³ë“¤ì—¬ì„œ)
```java
// ìƒì„±ìê°€ í•˜ë‚˜ë§Œ ìˆì„ ê²½ìš°ì—ëŠ” ì–´ë…¸í…Œì´ì…˜ ìƒëµ ê°€ëŠ¥
@Autowired
public JdbcTemplateMemberRepository(DataSource dataSource) {
    this.jdbcTemplate = new JdbcTemplate(dataSource);
    }
```
## RowMapper<T>
ì²˜ìŒ ë³´ëŠ” ì•„ì´ì—¬ì„œ ë­”ì§€ë„ ëª¨ë¥´ê³  ë”°ë¼ ì¹¨.. [ê³µë¶€ëŠ” ì—¬ê¸°ì— ì •ë¦¬]()
```java
private RowMapper<Member> memberRowMapper() {
  return new RowMapper() {
    @Override
    public Member mapRow(ResultSet rs, int rowNum) throws SQLException {

      Member member = new Member();
      member.setId(rs.getLong("id"));
      member.setName(rs.getString("name"));

      return member;
    }
  }
}
```

- ëŒë‹¤ë¡œ ë°”ê¾¸ë©´
```java
private RowMapper<Member> memberRowMapper() {
  return (rs, rowNum) -> {
    Member member = new Member();
    member.setId(rs.getLong("id"));
    member.setName(rs.getString("name"));

    return member;
  };
}
```

## ê° ë©”ì†Œë“œ ì¬ì •ì˜
- memberRowMapper()ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë„£ì–´ì¤€ë‹¤.
```java
    @Override
    public Member save(Member member) {
        SimpleJdbcInsert jdbcInsert = new SimpleJdbcInsert(jdbcTemplate);
        // ì¿¼ë¦¬ë¥¼ ì§¤ í•„ìš”ê°€ ì—†ìŒ
        jdbcInsert.withTableName("member").usingGeneratedKeyColumns("id");

        Map<String, Object> parameters = new HashMap<>();
        parameters.put("name" , member.getName());

        Number key = jdbcInsert.executeAndReturnKey(new MapSqlParameterSource(parameters));
        member.setId(key.longValue());

        return member;
    }

    @Override
    public Optional<Member> findById(Long id) {
        List<Member> result = jdbcTemplate.query("SELECT * FROM member WHERE id = ?", memberRowMapper(), id);

        return result.stream().findAny(); // Optionalë¡œ ë°˜í™˜
    }

    @Override
    public Optional<Member> findByName(String name) {
        // ì¿¼ë¦¬ ë‚ ë¦¬ê³  ê²°ê³¼ë¥¼ RowMapperë¥¼ í†µí•´ ë§¤í•‘í•˜ê³  Listë¡œ ë°›ìŒ
        List<Member> result = jdbcTemplate.query("SELECT * FROM member WHERE name = ?", memberRowMapper(), name);
        // ë°›ì€ ê²°ê³¼ë¥¼ Optionalë¡œ ë°”ê¿”ì„œ ë°˜í™˜
        return result.stream().findAny();
    }

    @Override
    public List<Member> findAll() {
      // Listë¡œ ë°˜í™˜
      return jdbcTemplate.query("SELECT * FROM member", memberRowMapper());
    }
```
### save ë©”ì†Œë“œ
- í…Œì´ë¸”ëª…ê³¼ PK ê°’ì„ ì´ìš©. ì—­ì‹œ ì¿¼ë¦¬ë¬¸ì„ ì“¸ í•„ìš”ê°€ ì—†ë‹¤.

## SpringConfig íŒŒì¼ ì„¤ì •
```java
    @Bean
    public MemberRepository memberRepository() {
//        return new MemoryMemberRepository();
//        return new JdbcMemberRepository(dataSource);
        return new JdbcTemplateMemberRepository(dataSource);

    }
```

## í…ŒìŠ¤íŠ¸
- Spring í†µí•© í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•˜ì˜€ìœ¼ë¯€ë¡œ, WASë¥¼ ë„ìš¸ í•„ìš” ì—†ì´ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ë°”ë¡œ ì‹¤í–‰ì‹œí‚¤ë©´ ë¨.
- ğŸ’¡ `ctrl + R`: ì œì¼ ë§ˆì§€ë§‰ì— ì‹¤í–‰ì‹œí‚¨ ì½”ë“œë¥¼ ì‹¤í–‰í•¨(cmd ì•„ë‹ˆê³  `ctrl`)

- í…ŒìŠ¤íŠ¸ ê²°ê³¼
![](img/day10_jdbcTemplateTest.png)
- ì„±ê³µ!